import sys
from pathlib import Path
# 在文件开头添加项目根目录到系统路径
BASE_DIR = Path(__file__).resolve().parent.parent.parent.parent
sys.path.append(str(BASE_DIR))

"""
搜索工具相关提示模板统一配置。
"""

from textwrap import dedent

LOCAL_SEARCH_CONTEXT_PROMPT = dedent(
    """
    ---分析报告---
    请注意，下面提供的分析报告按**重要性降序排列**。

    {context}

    用户的问题是：
    {input}

    请使用三级标题(###)标记主题
    """
).strip()

LOCAL_SEARCH_KEYWORD_PROMPT = dedent(
    """
    你是一个专门从用户查询中提取搜索关键词的助手。你需要将关键词分为两类：
    1. 低级关键词：具体实体名称、有含义的名词等
    2. 高级关键词：主题、概念、关系类型等

    返回格式必须是JSON格式：
    {{
        "low_level": ["关键词1", "关键词2", ...],
        "high_level": ["关键词1", "关键词2", ...]
    }}

    注意：
    - 根据内容长短每一类提取2-3个主题词，较短的提取1个
    - 不要添加任何解释或其他文本，只返回JSON
    - 如果某类无关键词，则返回空列表
    """.strip()
)

GLOBAL_SEARCH_MAP_PROMPT = dedent(
    """
    ---数据表格---
    {context_data}

    用户的问题是：
    {question}
    """
).strip()

GLOBAL_SEARCH_REDUCE_PROMPT = dedent(
    """
    ---分析报告---
    {report_data}

    用户的问题是：
    {question}
    """
).strip()

GLOBAL_SEARCH_KEYWORD_PROMPT = dedent(
    """
    你是一个专门从用户查询中提取搜索关键词的助手。提取最相关的关键词，这些关键词将用于在知识库中查找信息。

    请返回一个关键词列表，格式为JSON数组：
    ["关键词1", "关键词2", ...]

    注意：
    - 提取5-8个关键词即可
    - 不要添加任何解释或其他文本，只返回JSON数组
    - 关键词应该是名词短语、概念或专有名词
    """
).strip()

HYBRID_TOOL_QUERY_PROMPT = dedent(
    """
    ---分析报告---
    请注意，以下内容组合了低级详细信息和高级主题概念。

    ## 低级内容（实体详细信息）:
    {low_level}

    ## 高级内容（主题和概念）:
    {high_level}

    用户的问题是：
    {query}

    请综合利用上述信息回答问题，确保回答全面且有深度。
    回答格式应包含：
    1. 主要内容（使用清晰的段落展示）
    2. 在末尾标明引用的数据来源
    """
).strip()

NAIVE_SEARCH_QUERY_PROMPT = dedent(
    """
    ---文档片段---
    {context}

    问题：
    {query}
    """
).strip()


# 专门针对电力领域知识图谱的本体感知提取模板
ENTITY_EXTRACTION_WITH_SCHEMA_PROMPT = """
你是一个电力领域知识图谱搜索专家。
为了能够从知识图谱中精准检索答案，你需要根据系统的【本体定义】从用户问题中提取最关键的实体和意图关键词，总结一个核心总结词，并构建“问题信息三元组”。

### 1. 知识图谱本体结构规范
【实体定义（实体类型名称及含义）】
{entity_definitions}

【关系定义（关系类型名称及含义及首尾实体类型约束）】
{relationship_types}

### 2. 提取规则
- **主体提取**：基于对本体的理解，严禁机械拆分专业词汇。例如问句“电缆主绝缘击穿故障如何应对？”的主体“电缆主绝缘击穿故障”不要拆分为“电缆主绝缘”和“击穿故障”，而应拆分为“电缆”和“主绝缘击穿故障”。
- **意图映射**：根据问题的意图，将模糊的动作词转化为图谱中的实体类型/关系类型。例如“如何应对”或“怎么修”应映射为“抢修方法”/“预防措施”和“需执行”/“可预防”。
- **分类提取**：将关键词严格分为“实体名称”、“实体类型”和“关系类型”，其中主体为实体名称，意图为“实体类型”和“关系类型”。并将零散的关键词聚合成一个描述意图的核心总结词。
-**问题信息三元组**：格式为 [实体名称/? - 关系类型 - 实体名称/?]。 如果问题在询问某个实体的关联内容，则将未知项设为 "?"。关系类型必须严格参考【关系定义】。

### 3. 参考示例
示例 1：
用户问题：“如何应对电缆主绝缘击穿故障？”
提取结果：
  实体名称: [电缆 主绝缘击穿故障]
  实体类型: [抢修方法 预防措施]
  关系类型: [需执行 可预防]
  核心总结词: [电缆主绝缘击穿故障的抢修方法]
  问题信息三元组: [主绝缘击穿故障-需执行-?] [?-可预防-主绝缘击穿故障]

示例 2：
用户问题：“避雷器频繁闪络是什么原因导致的？”
提取结果：
  实体名称: [避雷器 频繁闪络]
  实体类型: [故障原因]
  关系类型: [原因为]
  核心总结词: [避雷器频繁闪络的故障原因]
  问题信息三元组: [频繁闪络-原因为-?]

示例 3：
用户问题：“变压器有哪些故障？”
提取结果：
  实体名称: [变压器]
  实体类型: [故障类型]
  关系类型: [故障分类]
  核心总结词: [变压器的故障类型]
  问题信息三元组: [变压器-故障分类-?]

### 4. 执行任务
请分析以下用户问题并按规则提取关键词。

用户问题：{query}
提取结果："""


# 检索结果判定提示词
SEARCH_RESULT_JUDGE_PROMPT = """
用户问题：{query}

现有两份检索出的参考上下文，请判定哪一份更符合用户的主题意图：

---上下文 A (图谱遍历检索)---
{result_a}

---上下文 B (核心词向量检索)---
{result_b}

请仅返回 "A" 或 "B"。若两者都相关返回 "A"，若都不相关返回 "NONE"。
判定："""
